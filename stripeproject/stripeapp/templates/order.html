<!DOCTYPE html>
<html>
<head>
    <title>Order</title>
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <h1>Order</h1>
    {% for order_item in order.orderitem_set.all %}
        <h2>{{ order_item.item.name }}</h2>
        <p>{{ order_item.item.description }}</p>
        <p>{{ order_item.item.price }}</p>
        <p>Quantity: {{ order_item.quantity }}</p>
    {% endfor %}
    <p>Discount: {{ order.discount.amount }}</p>
    <p>Tax: {{ order.tax.amount }}</p>
    <p>Total: {{ total_amount }}</p>
    <div id="card-element"><!--Stripe.js injects the Card Element--></div>
    <button id="buy-button">Buy</button>
    <p id="message"></p>
    <script>
        var stripe = Stripe('{{ stripe_publishable_key }}');
        var elements = stripe.elements();
        var cardElement = elements.create('card');
        cardElement.mount('#card-element');
        var buyButton = document.getElementById('buy-button');
        var message = document.getElementById('message');
        buyButton.addEventListener('click', function() {
            // Disable the button
            buyButton.disabled = true;
            fetch('/buy/order/{{ order.id }}', {method: 'GET'})
            .then(response => response.json())
            .then(function(data) {
                return stripe.confirmCardPayment(data.client_secret, {
                    payment_method: {
                        card: cardElement,
                        billing_details: {
                            name: 'Your Customer Name',
                        },
                    }
                });
            })
            .then(function(result) {
                if (result.error) {
                    // Show error to your customer
                    console.log(result.error.message);
                    message.textContent = 'Payment failed: ' + result.error.message;
                    // Enable the button
                    buyButton.disabled = false;
                } else {
                    if (result.paymentIntent.status === 'succeeded') {
                        // The payment has been processed!
                        console.log('Payment succeeded!');
                        message.textContent = 'Payment succeeded!';
                    }
                }
            });
        });
    </script>
</body>
</html>